name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (e.g., v1.2.3)'
        required: true
        type: string

env:
  NODE_VERSION: '18.x'

jobs:
  test:
    name: Run Tests
    uses: ./.github/workflows/test.yml

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: production
      url: https://hummytummy.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Backup Production Database
        env:
          SERVER_HOST: ${{ secrets.PRODUCTION_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PRODUCTION_SERVER_USER }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
            cd /opt/kds
            ./scripts/backup-database.sh
          EOF

      - name: Deploy to Production Server
        env:
          SERVER_HOST: ${{ secrets.PRODUCTION_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PRODUCTION_SERVER_USER }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
            cd /opt/kds

            # Pull latest changes
            git fetch --all
            git checkout main
            git pull origin main

            # Build and restart production environment
            docker-compose -f docker-compose.prod.yml build
            docker-compose -f docker-compose.prod.yml up -d --no-deps backend frontend

            # Run migrations (with backup already created)
            docker-compose -f docker-compose.prod.yml exec -T backend npx prisma migrate deploy

            # Health check
            sleep 15
            curl -f https://hummytummy.com/api/health || exit 1
          EOF

      - name: Verify deployment
        env:
          SERVER_HOST: ${{ secrets.PRODUCTION_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PRODUCTION_SERVER_USER }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
            cd /opt/kds
            docker-compose -f docker-compose.prod.yml ps
          EOF

      - name: Create Git Tag
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a ${{ github.event.inputs.version }} -m "Release ${{ github.event.inputs.version }}"
          git push origin ${{ github.event.inputs.version }}

      - name: Create GitHub Release
        if: success()
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.version }}
          release_name: Release ${{ github.event.inputs.version }}
          body: |
            Production deployment of version ${{ github.event.inputs.version }}

            Deployed at: ${{ github.event.head_commit.timestamp }}
            Commit: ${{ github.sha }}
          draft: false
          prerelease: false

      - name: Rollback on failure
        if: failure()
        env:
          SERVER_HOST: ${{ secrets.PRODUCTION_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PRODUCTION_SERVER_USER }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
            cd /opt/kds
            ./scripts/rollback-deployment.sh
          EOF

      - name: Notify deployment status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '✅ Success' : '❌ Failed';
            const message = status === '✅ Success'
              ? `Production deployment of ${context.payload.inputs.version} completed successfully!`
              : `Production deployment of ${context.payload.inputs.version} failed. Rollback initiated.`;

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `${status} ${message}\nEnvironment: https://hummytummy.com`
            });
