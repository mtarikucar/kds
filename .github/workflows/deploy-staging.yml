name: Deploy to Staging

on:
  push:
    branches: [main]

env:
  NODE_VERSION: '18.x'

jobs:
  test:
    name: Run Tests
    uses: ./.github/workflows/test.yml

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test
    environment:
      name: staging
      url: http://38.242.233.166:3002

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}

      - name: Deploy to Staging Server
        env:
          SERVER_HOST: ${{ secrets.STAGING_SERVER_HOST }}
          SERVER_USER: ${{ secrets.STAGING_SERVER_USER }}
        run: |
          ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
            cd /opt/kds
            git pull origin main

            # Build and restart staging environment
            docker-compose -f docker-compose.staging.yml down
            docker-compose -f docker-compose.staging.yml build
            docker-compose -f docker-compose.staging.yml up -d

            # Run migrations
            docker-compose -f docker-compose.staging.yml exec -T backend npx prisma migrate deploy

            # Health check
            sleep 10
            curl -f http://localhost:3002/api/health || exit 1
          EOF

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Staging deployment successful"
          else
            echo "❌ Staging deployment failed"
          fi

      - name: Create deployment notification
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const status = '${{ job.status }}' === 'success' ? '✅ Success' : '❌ Failed';
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `Staging Deployment: ${status}\nEnvironment: http://38.242.233.166:3002`
            });
