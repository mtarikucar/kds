name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - production
          - staging
          - development

jobs:
  # Backend Tests
  backend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run Prisma generate
        run: npx prisma generate

      - name: Run linter
        run: npm run lint

      - name: Run tests
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
        run: npm run test

      - name: Build
        run: npm run build

  # Frontend Tests
  frontend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build
        run: npm run build

  # Deploy to Development (auto-deploy on push to develop)
  deploy-dev:
    needs: [backend-test, frontend-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: development
      url: http://${{ secrets.SERVER_HOST }}:5174

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Development Environment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/kds
            git fetch origin develop
            git checkout develop
            git pull origin develop

            # Load development environment
            cp .env.development .env

            # Build and restart containers
            docker-compose -f docker-compose.dev.yml down
            docker-compose -f docker-compose.dev.yml build
            docker-compose -f docker-compose.dev.yml up -d

            # Wait for backend to be ready
            sleep 10

            # Run migrations
            docker-compose -f docker-compose.dev.yml exec -T backend npx prisma migrate deploy

            # Verify deployment
            docker-compose -f docker-compose.dev.yml ps

      - name: Health Check
        run: |
          sleep 15
          curl -f http://${{ secrets.SERVER_HOST }}:3001/api || exit 1

  # Deploy to Staging (auto-deploy on push to main)
  deploy-staging:
    needs: [backend-test, frontend-test]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: staging
      url: http://${{ secrets.SERVER_HOST }}:5175

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Staging Environment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/kds
            git fetch origin main
            git checkout main
            git pull origin main

            # Load staging environment
            cp .env.staging .env

            # Build and restart containers
            docker-compose -f docker-compose.staging.yml down
            docker-compose -f docker-compose.staging.yml build
            docker-compose -f docker-compose.staging.yml up -d

            # Wait for backend to be ready
            sleep 10

            # Run migrations
            docker-compose -f docker-compose.staging.yml exec -T backend npx prisma migrate deploy

            # Verify deployment
            docker-compose -f docker-compose.staging.yml ps

      - name: Health Check
        run: |
          sleep 15
          curl -f http://${{ secrets.SERVER_HOST }}:3002/api || exit 1

  # Deploy to Production (manual approval required)
  deploy-production:
    needs: [backend-test, frontend-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: http://${{ secrets.SERVER_HOST }}

    steps:
      - uses: actions/checkout@v4

      - name: Create Deployment Backup
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/kds

            # Backup database
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            docker-compose -f docker-compose.prod.yml exec -T postgres pg_dump -U postgres restaurant_pos_prod > backup_prod_$TIMESTAMP.sql

            # Keep only last 5 backups
            ls -t backup_prod_*.sql | tail -n +6 | xargs -r rm

      - name: Deploy to Production Environment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/kds
            git fetch origin main
            git checkout main
            git pull origin main

            # Load production environment
            cp .env.production .env

            # Build and restart containers with zero-downtime
            docker-compose -f docker-compose.prod.yml build
            docker-compose -f docker-compose.prod.yml up -d --no-deps --build backend frontend

            # Wait for backend to be ready
            sleep 15

            # Run migrations
            docker-compose -f docker-compose.prod.yml exec -T backend npx prisma migrate deploy

            # Verify deployment
            docker-compose -f docker-compose.prod.yml ps

      - name: Health Check
        run: |
          sleep 20
          curl -f http://${{ secrets.SERVER_HOST }}:3000/api || exit 1

      - name: Notify Deployment
        if: success()
        run: echo "Production deployment successful!"

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /opt/kds
            echo "Deployment failed, rolling back..."
            docker-compose -f docker-compose.prod.yml down
            docker-compose -f docker-compose.prod.yml up -d
            echo "Rollback completed"
