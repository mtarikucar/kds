name: Test Environment Deployment

on:
  push:
    branches:
      - test
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual deployment'
        required: false
        default: 'Manual deployment'

permissions:
  contents: read
  packages: write

jobs:
  deploy-test:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest

    env:
      SERVER_HOST: '38.242.233.166'
      PROJECT_PATH: /root/kds

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: test
          fetch-depth: 0

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY_BASE64: ${{ secrets.SSH_PRIVATE_KEY_BASE64 }}
          SSH_KNOWN_HOSTS: ${{ secrets.SSH_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY_BASE64" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Validate SSH key format
        run: |
          echo "üîë Validating SSH key format..."
          if ! ssh-keygen -l -f ~/.ssh/id_ed25519 2>/dev/null; then
            echo "‚ùå SSH key validation failed!"
            exit 1
          fi
          echo "‚úÖ SSH key format is valid"

      - name: Verify SSH connection
        run: |
          echo "üîå Testing SSH connection to ${{ env.SERVER_HOST }}..."
          if ! ssh -o ConnectTimeout=10 -o BatchMode=yes -o StrictHostKeyChecking=yes root@${{ env.SERVER_HOST }} "echo 'SSH connection successful'" 2>&1; then
            echo "‚ùå SSH connection to test server failed!"
            exit 1
          fi
          echo "‚úÖ SSH connection test passed"

      - name: Get commit information
        id: commit_info
        run: |
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "commit_message=$(git log -1 --pretty=%s | head -c 100)" >> $GITHUB_OUTPUT
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT

      - name: Get version information
        id: version_info
        run: |
          echo "version=$(git describe --tags --always)" >> $GITHUB_OUTPUT
          echo "build_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          target: production
          push: true
          tags: ghcr.io/${{ github.repository }}/backend-staging:latest,ghcr.io/${{ github.repository }}/backend-staging:${{ steps.commit_info.outputs.commit_sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/backend-staging:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/backend-staging:buildcache,mode=max

      - name: Build and push frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          target: production
          push: true
          tags: ghcr.io/${{ github.repository }}/frontend-staging:latest,ghcr.io/${{ github.repository }}/frontend-staging:${{ steps.commit_info.outputs.commit_sha }}
          build-args: |
            VITE_API_URL=https://staging.hummytummy.com/api
            VITE_API_BASE_URL=https://staging.hummytummy.com
            VITE_SOCKET_URL=https://staging.hummytummy.com
            VITE_WS_URL=wss://staging.hummytummy.com
            VITE_GOOGLE_CLIENT_ID=${{ secrets.VITE_GOOGLE_CLIENT_ID }}
            VITE_APP_VERSION=${{ steps.version_info.outputs.version }}
            VITE_BUILD_TIME=${{ steps.version_info.outputs.build_time }}
            VITE_COMMIT_SHA=${{ steps.commit_info.outputs.commit_sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/frontend-staging:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/frontend-staging:buildcache,mode=max

      - name: Build and push landing image
        uses: docker/build-push-action@v5
        with:
          context: ./landing
          file: ./landing/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}/landing-staging:latest,ghcr.io/${{ github.repository }}/landing-staging:${{ steps.commit_info.outputs.commit_sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://staging.hummytummy.com/api
            NEXT_PUBLIC_SITE_URL=https://staging.hummytummy.com
          cache-from: type=registry,ref=ghcr.io/${{ github.repository }}/landing-staging:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository }}/landing-staging:buildcache,mode=max

      - name: Deploy to test environment
        run: |
          echo "=========================================="
          echo "Test Environment Deployment Started"
          echo "=========================================="
          echo ""
          echo "Version: ${{ steps.version_info.outputs.version }}"
          echo "Commit: ${{ steps.commit_info.outputs.commit_sha }}"
          echo "Author: ${{ steps.commit_info.outputs.author }}"
          echo "Message: ${{ steps.commit_info.outputs.commit_message }}"
          echo "Trigger: ${{ github.event_name }}"
          echo ""

          ssh root@${{ env.SERVER_HOST }} << EOF
            set -e
            cd ${{ env.PROJECT_PATH }}

            # Create database backup
            echo "Creating database backup..."
            mkdir -p backups/database
            BACKUP_FILE="backups/database/backup_test_\$(date +%Y%m%d_%H%M%S).sql.gz"
            docker exec kds_postgres_staging pg_dump -U postgres -d restaurant_pos_staging | gzip > "\$BACKUP_FILE" || echo "Backup failed, continuing..."

            # Keep only last 3 test backups
            ls -t backups/database/backup_test_*.sql.gz 2>/dev/null | tail -n +4 | xargs -r rm || true

            # Login to GitHub Container Registry
            echo "Logging in to GitHub Container Registry..."
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull latest images from GHCR
            echo "Pulling new images..."
            docker pull ghcr.io/${{ github.repository }}/backend-staging:latest
            docker pull ghcr.io/${{ github.repository }}/frontend-staging:latest
            docker pull ghcr.io/${{ github.repository }}/landing-staging:latest

            # Stop existing containers
            echo "Stopping existing containers..."
            docker-compose -f docker-compose.staging.yml down || true

            # Start new containers
            echo "Starting new containers..."
            docker-compose -f docker-compose.staging.yml up -d

            # Run database migrations
            echo "Running database migrations..."
            sleep 10
            docker exec kds_backend_staging npx prisma migrate deploy || echo "Migration failed or no new migrations"

            echo ""
            echo "=========================================="
            echo "Deployment completed successfully!"
            echo "=========================================="
          EOF

      - name: Verify deployment health
        run: |
          echo "Waiting 30 seconds for services to stabilize..."
          sleep 30

          ssh root@${{ env.SERVER_HOST }} << 'EOF'
            cd ${{ env.PROJECT_PATH }}

            # Health check
            echo "Performing health check..."
            HEALTH_URL="http://localhost:3002/api/health"
            MAX_RETRIES=30
            RETRY_INTERVAL=2

            for i in $(seq 1 $MAX_RETRIES); do
              if curl -sf "$HEALTH_URL" > /dev/null 2>&1; then
                echo "‚úÖ Health check passed! Backend is healthy"

                # Show container status
                echo ""
                echo "Container Status:"
                docker ps --filter 'name=kds_.*_staging' --format 'table {{.Names}}\t{{.Status}}\t{{.Ports}}'

                exit 0
              fi
              echo "Health check attempt $i/$MAX_RETRIES failed, retrying in ${RETRY_INTERVAL}s..."
              sleep $RETRY_INTERVAL
            done

            echo "‚ùå Health check failed after $MAX_RETRIES attempts"
            echo "Container logs:"
            docker logs kds_backend_staging --tail 50
            exit 1
          EOF

      - name: Send success notification
        if: success()
        run: |
          echo "‚úÖ Test deployment successful!"
          echo "üåê URL: https://staging.hummytummy.com"
          echo "üìù Commit: ${{ steps.commit_info.outputs.commit_sha }}"

      - name: Send failure notification
        if: failure()
        run: |
          echo "‚ùå Test deployment failed!"
          echo "üìù Commit: ${{ steps.commit_info.outputs.commit_sha }}"
          echo "üîÑ Rollback may have been triggered automatically"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/id_ed25519

