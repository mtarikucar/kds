// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// TENANT & USER MANAGEMENT
// ========================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  subdomain String?  @unique
  status    String   @default("ACTIVE") // ACTIVE, SUSPENDED, DELETED

  // Subscription details
  currentPlanId   String?
  paymentRegion   String   @default("INTERNATIONAL") // TURKEY, INTERNATIONAL
  trialUsed       Boolean  @default(false)
  trialStartedAt  DateTime?
  trialEndsAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users               User[]
  categories          Category[]
  products            Product[]
  tables              Table[]
  orders              Order[]
  stockMovements      StockMovement[]
  subscriptions       Subscription[]
  currentPlan         SubscriptionPlan?  @relation("CurrentPlan", fields: [currentPlanId], references: [id], onDelete: SetNull)

  @@index([currentPlanId])
  @@map("tenants")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      String   // ADMIN, MANAGER, WAITER, KITCHEN, COURIER
  status    String   @default("ACTIVE") // ACTIVE, INACTIVE

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders         Order[]
  stockMovements StockMovement[]

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

// ========================================
// MENU MANAGEMENT
// ========================================

model Category {
  id           String  @id @default(uuid())
  name         String
  description  String?
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products Product[]

  @@index([tenantId])
  @@map("categories")
}

model Product {
  id          String  @id @default(uuid())
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  image       String?

  isAvailable  Boolean @default(true)
  stockTracked Boolean @default(false)
  currentStock Int     @default(0)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orderItems     OrderItem[]
  stockMovements StockMovement[]

  @@index([tenantId])
  @@index([categoryId])
  @@map("products")
}

// ========================================
// TABLE MANAGEMENT
// ========================================

model Table {
  id       String  @id @default(uuid())
  number   String
  capacity Int
  section  String?
  status   String  @default("AVAILABLE") // AVAILABLE, OCCUPIED, RESERVED

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders Order[]

  @@unique([tenantId, number])
  @@index([tenantId])
  @@map("tables")
}

// ========================================
// ORDER MANAGEMENT
// ========================================

model Order {
  id          String   @id @default(uuid())
  orderNumber String
  type        String   // DINE_IN, TAKEAWAY, DELIVERY
  status      String   @default("PENDING") // PENDING, PREPARING, READY, SERVED, PAID, CANCELLED

  totalAmount  Decimal @db.Decimal(10, 2)
  discount     Decimal @default(0) @db.Decimal(10, 2)
  finalAmount  Decimal @db.Decimal(10, 2)

  notes        String?
  customerName String?

  tableId String?
  table   Table?  @relation(fields: [tableId], references: [id], onDelete: SetNull)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?

  // Relations
  orderItems OrderItem[]
  payments   Payment[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([userId])
  @@index([tableId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(10, 2)
  notes     String?
  status    String  @default("PENDING") // PENDING, PREPARING, READY

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ========================================
// PAYMENT MANAGEMENT
// ========================================

model Payment {
  id     String  @id @default(uuid())
  amount Decimal @db.Decimal(10, 2)
  method String  // CASH, CARD, DIGITAL
  status String  @default("PENDING") // PENDING, COMPLETED, FAILED, REFUNDED

  transactionId String?
  notes         String?

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  paidAt    DateTime?

  @@index([orderId])
  @@index([status])
  @@map("payments")
}

// ========================================
// STOCK MANAGEMENT
// ========================================

model StockMovement {
  id       String @id @default(uuid())
  type     String // IN, OUT, ADJUSTMENT
  quantity Int
  reason   String?
  notes    String?

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([productId])
  @@index([userId])
  @@map("stock_movements")
}

// ========================================
// SUBSCRIPTION MANAGEMENT
// ========================================

model SubscriptionPlan {
  id          String  @id @default(uuid())
  name        String  @unique // FREE, BASIC, PRO, BUSINESS
  displayName String
  description String?

  // Pricing
  monthlyPrice Decimal @db.Decimal(10, 2)
  yearlyPrice  Decimal @db.Decimal(10, 2)
  currency     String  @default("USD")

  // Trial settings
  trialDays Int @default(0)

  // Feature limits
  maxUsers           Int     @default(1)
  maxTables          Int     @default(5)
  maxProducts        Int     @default(50)
  maxCategories      Int     @default(10)
  maxMonthlyOrders   Int     @default(100)

  // Feature flags
  advancedReports    Boolean @default(false)
  multiLocation      Boolean @default(false)
  customBranding     Boolean @default(false)
  apiAccess          Boolean @default(false)
  prioritySupport    Boolean @default(false)
  inventoryTracking  Boolean @default(false)
  kdsIntegration     Boolean @default(true)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions      Subscription[]
  currentPlanTenants Tenant[]       @relation("CurrentPlan")

  @@map("subscription_plans")
}

model Subscription {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)

  // Subscription details
  status          String   @default("ACTIVE") // ACTIVE, CANCELLED, EXPIRED, PAST_DUE, TRIALING
  billingCycle    String   // MONTHLY, YEARLY
  paymentProvider String   // STRIPE, IYZICO

  // Dates
  startDate       DateTime @default(now())
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt     DateTime?
  endedAt         DateTime?

  // Trial tracking
  isTrialPeriod Boolean  @default(false)
  trialStart    DateTime?
  trialEnd      DateTime?

  // Payment provider IDs
  stripeSubscriptionId String? @unique
  iyzicoSubscriptionId String? @unique
  stripeCustomerId     String?
  iyzicoCustomerId     String?

  // Pricing at time of subscription
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("USD")

  // Auto-renewal
  autoRenew       Boolean @default(true)
  cancelAtPeriodEnd Boolean @default(false)

  // Cancellation tracking
  cancellationReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  payments SubscriptionPayment[]
  invoices Invoice[]

  @@index([tenantId])
  @@index([planId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

model SubscriptionPayment {
  id String @id @default(uuid())

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Payment details
  amount          Decimal @db.Decimal(10, 2)
  currency        String  @default("USD")
  status          String  @default("PENDING") // PENDING, SUCCEEDED, FAILED, REFUNDED
  paymentProvider String  // STRIPE, IYZICO

  // Provider-specific IDs
  stripePaymentIntentId String? @unique
  iyzicoPaymentId       String? @unique

  // Payment metadata
  paymentMethod String? // card, bank_transfer, etc.
  last4         String?
  cardBrand     String?

  // Error tracking
  failureCode    String?
  failureMessage String?
  retryCount     Int     @default(0)

  // Dates
  paidAt    DateTime?
  refundedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  invoice Invoice?

  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
  @@map("subscription_payments")
}

model Invoice {
  id String @id @default(uuid())

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  paymentId String? @unique
  payment   SubscriptionPayment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  // Invoice details
  invoiceNumber String  @unique
  status        String  @default("DRAFT") // DRAFT, OPEN, PAID, VOID, UNCOLLECTIBLE

  // Amounts
  subtotal Decimal @db.Decimal(10, 2)
  tax      Decimal @default(0) @db.Decimal(10, 2)
  total    Decimal @db.Decimal(10, 2)
  currency String  @default("USD")

  // Billing period
  periodStart DateTime
  periodEnd   DateTime

  // Dates
  dueDate   DateTime?
  paidAt    DateTime?
  voidedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Metadata
  description String?
  notes       String?
  pdfUrl      String?

  @@index([subscriptionId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}
