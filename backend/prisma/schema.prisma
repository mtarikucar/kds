// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// TENANT & USER MANAGEMENT
// ========================================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  subdomain String?  @unique
  status    String   @default("ACTIVE") // ACTIVE, SUSPENDED, DELETED

  // Subscription details
  currentPlanId   String?
  paymentRegion   String   @default("INTERNATIONAL") // TURKEY, INTERNATIONAL
  trialUsed       Boolean  @default(false)
  trialStartedAt  DateTime?
  trialEndsAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users               User[]
  categories          Category[]
  products            Product[]
  productImages       ProductImage[]
  modifierGroups      ModifierGroup[]
  modifiers           Modifier[]
  tables              Table[]
  orders              Order[]
  stockMovements      StockMovement[]
  subscriptions       Subscription[]
  qrMenuSettings      QrMenuSettings?
  posSettings         PosSettings?
  integrationSettings IntegrationSettings[]
  apiKeys             ApiKey[]
  customers           Customer[]
  notifications       Notification[]
  zReports            ZReport[]
  currentPlan         SubscriptionPlan?  @relation("CurrentPlan", fields: [currentPlanId], references: [id], onDelete: SetNull)

  @@index([currentPlanId])
  @@map("tenants")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  firstName String
  lastName  String
  role      String   // ADMIN, MANAGER, WAITER, KITCHEN, COURIER
  status    String   @default("ACTIVE") // ACTIVE, INACTIVE

  // Email verification (code-based)
  emailVerified                 Boolean   @default(false)
  emailVerificationCode         String?   @db.VarChar(6)
  emailVerificationCodeExpires  DateTime?

  // Password reset
  resetToken       String?   @unique
  resetTokenExpiry DateTime?

  // Profile
  avatar    String?
  phone     String?
  lastLogin DateTime?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders                         Order[]
  approvedOrders                 Order[] @relation("ApprovedOrders")
  acknowledgedWaiterRequests     WaiterRequest[] @relation("AcknowledgedWaiterRequests")
  acknowledgedBillRequests       BillRequest[] @relation("AcknowledgedBillRequests")
  stockMovements                 StockMovement[]
  notifications                  Notification[]
  readNotifications              UserNotificationRead[]
  zReports                       ZReport[]
  cashDrawerMovements            CashDrawerMovement[]

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

// ========================================
// MENU MANAGEMENT
// ========================================

model Category {
  id           String  @id @default(uuid())
  name         String
  description  String?
  displayOrder Int     @default(0)
  isActive     Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  products Product[]

  @@index([tenantId])
  @@map("categories")
}

model Product {
  id          String  @id @default(uuid())
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  image       String? // Legacy field, kept for backwards compatibility

  isAvailable  Boolean @default(true)
  stockTracked Boolean @default(false)
  currentStock Int     @default(0)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  productImages      ProductToImage[]      // Many-to-many through junction table
  orderItems         OrderItem[]
  stockMovements     StockMovement[]
  modifierGroups     ProductModifierGroup[] // Many-to-many for modifiers

  @@index([tenantId])
  @@index([categoryId])
  @@map("products")
}

model ProductImage {
  id       String @id @default(uuid())
  url      String // File path or URL
  filename String // Original filename
  size     Int    // File size in bytes
  mimeType String // image/jpeg, image/png, image/webp

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  // Relations
  products ProductToImage[] // Many-to-many through junction table

  @@index([tenantId])
  @@map("product_images")
}

// Junction table for many-to-many relationship between Product and ProductImage
model ProductToImage {
  id    String @id @default(uuid())
  order Int    @default(0) // Display order (0 = primary image)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  imageId String
  image   ProductImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([productId, imageId]) // Prevent duplicate links
  @@index([productId, order])
  @@index([imageId])
  @@map("product_to_images")
}

// ========================================
// PRODUCT MODIFIER SYSTEM
// ========================================

model ModifierGroup {
  id             String  @id @default(uuid())
  name           String  // Internal name (e.g., "sauces")
  displayName    String  // Display name (e.g., "Soslar", "Sauces")
  description    String?
  selectionType  String  @default("SINGLE") // SINGLE or MULTIPLE
  minSelections  Int     @default(0) // Minimum number of selections required
  maxSelections  Int? // Maximum number of selections allowed (null = unlimited)
  isRequired     Boolean @default(false)
  displayOrder   Int     @default(0)
  isActive       Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  modifiers        Modifier[]
  productMappings  ProductModifierGroup[]

  @@index([tenantId])
  @@index([isActive])
  @@map("modifier_groups")
}

model Modifier {
  id              String  @id @default(uuid())
  name            String  // Internal name (e.g., "ranch_sauce")
  displayName     String  // Display name (e.g., "Ranch Sos", "Ranch Sauce")
  description     String?
  priceAdjustment Decimal @default(0) @db.Decimal(10, 2) // Price change (can be positive or negative)
  isAvailable     Boolean @default(true)
  displayOrder    Int     @default(0)

  groupId String
  group   ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orderItemModifiers OrderItemModifier[]

  @@index([groupId])
  @@index([tenantId])
  @@index([isAvailable])
  @@map("modifiers")
}

// Junction table for many-to-many relationship between Product and ModifierGroup
model ProductModifierGroup {
  id           String @id @default(uuid())
  displayOrder Int    @default(0)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  groupId String
  group   ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([productId, groupId])
  @@index([productId])
  @@index([groupId])
  @@map("product_modifier_groups")
}

// ========================================
// TABLE MANAGEMENT
// ========================================

model Table {
  id       String  @id @default(uuid())
  number   String
  capacity Int
  section  String?
  status   String  @default("AVAILABLE") // AVAILABLE, OCCUPIED, RESERVED

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders         Order[]
  waiterRequests WaiterRequest[]
  billRequests   BillRequest[]

  @@unique([tenantId, number])
  @@index([tenantId])
  @@map("tables")
}

// ========================================
// ORDER MANAGEMENT
// ========================================

model Order {
  id          String   @id @default(uuid())
  orderNumber String
  type        String   // DINE_IN, TAKEAWAY, DELIVERY
  status      String   @default("PENDING") // PENDING_APPROVAL, PENDING, PREPARING, READY, SERVED, PAID, CANCELLED

  totalAmount  Decimal @db.Decimal(10, 2)
  discount     Decimal @default(0) @db.Decimal(10, 2)
  finalAmount  Decimal @db.Decimal(10, 2)

  notes        String?
  customerName String?

  // Customer ordering fields
  sessionId        String? // UUID for customer session tracking
  customerPhone    String? // Optional customer phone
  requiresApproval Boolean @default(false) // If true, waiter must approve before going to kitchen
  approvedAt       DateTime? // When the order was approved

  tableId String?
  table   Table?  @relation(fields: [tableId], references: [id], onDelete: SetNull)

  customerId String?
  customer   Customer? @relation("CustomerOrders", fields: [customerId], references: [id], onDelete: SetNull)

  userId String? // Nullable for customer orders
  user   User?   @relation(fields: [userId], references: [id], onDelete: Restrict)

  approvedById String? // Staff who approved the order
  approvedBy   User?   @relation("ApprovedOrders", fields: [approvedById], references: [id], onDelete: SetNull)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?

  // Relations
  orderItems OrderItem[]
  payments   Payment[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([userId])
  @@index([tableId])
  @@index([customerId])
  @@index([status])
  @@index([sessionId])
  @@index([approvedById])
  @@map("orders")
}

model OrderItem {
  id            String  @id @default(uuid())
  quantity      Int
  unitPrice     Decimal @db.Decimal(10, 2)
  subtotal      Decimal @db.Decimal(10, 2)
  modifierTotal Decimal @default(0) @db.Decimal(10, 2) // Total cost of modifiers
  notes         String?
  status        String  @default("PENDING") // PENDING, PREPARING, READY

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  modifiers OrderItemModifier[]

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// Modifiers selected for a specific order item
model OrderItemModifier {
  id              String  @id @default(uuid())
  quantity        Int     @default(1) // How many of this modifier (e.g., 2x extra cheese)
  priceAdjustment Decimal @db.Decimal(10, 2) // Price at the time of order

  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  modifierId String
  modifier   Modifier @relation(fields: [modifierId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())

  @@index([orderItemId])
  @@index([modifierId])
  @@map("order_item_modifiers")
}

// ========================================
// PAYMENT MANAGEMENT
// ========================================

model Payment {
  id     String  @id @default(uuid())
  amount Decimal @db.Decimal(10, 2)
  method String  // CASH, CARD, DIGITAL
  status String  @default("PENDING") // PENDING, COMPLETED, FAILED, REFUNDED

  transactionId String?
  notes         String?

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  paidAt    DateTime?

  @@index([orderId])
  @@index([status])
  @@map("payments")
}

// ========================================
// STOCK MANAGEMENT
// ========================================

model StockMovement {
  id       String @id @default(uuid())
  type     String // IN, OUT, ADJUSTMENT
  quantity Int
  reason   String?
  notes    String?

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([productId])
  @@index([userId])
  @@map("stock_movements")
}

// ========================================
// SUBSCRIPTION MANAGEMENT
// ========================================

model SubscriptionPlan {
  id          String  @id @default(uuid())
  name        String  @unique // FREE, BASIC, PRO, BUSINESS
  displayName String
  description String?

  // Pricing
  monthlyPrice Decimal @db.Decimal(10, 2)
  yearlyPrice  Decimal @db.Decimal(10, 2)
  currency     String  @default("USD")

  // Trial settings
  trialDays Int @default(0)

  // Feature limits
  maxUsers           Int     @default(1)
  maxTables          Int     @default(5)
  maxProducts        Int     @default(50)
  maxCategories      Int     @default(10)
  maxMonthlyOrders   Int     @default(100)

  // Feature flags
  advancedReports    Boolean @default(false)
  multiLocation      Boolean @default(false)
  customBranding     Boolean @default(false)
  apiAccess          Boolean @default(false)
  prioritySupport    Boolean @default(false)
  inventoryTracking  Boolean @default(false)
  kdsIntegration     Boolean @default(true)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions           Subscription[]
  currentPlanTenants      Tenant[]             @relation("CurrentPlan")
  pendingChangesFrom      PendingPlanChange[]  @relation("PendingFromPlan")
  pendingChangesTo        PendingPlanChange[]  @relation("PendingToPlan")

  @@map("subscription_plans")
}

model Subscription {
  id String @id @default(uuid())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)

  // Subscription details
  status          String   @default("ACTIVE") // ACTIVE, CANCELLED, EXPIRED, PAST_DUE, TRIALING
  billingCycle    String   // MONTHLY, YEARLY
  paymentProvider String   // STRIPE, IYZICO

  // Dates
  startDate       DateTime @default(now())
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt     DateTime?
  endedAt         DateTime?

  // Trial tracking
  isTrialPeriod Boolean  @default(false)
  trialStart    DateTime?
  trialEnd      DateTime?

  // Payment provider IDs
  stripeSubscriptionId String? @unique
  iyzicoSubscriptionId String? @unique
  stripeCustomerId     String?
  iyzicoCustomerId     String?

  // Pricing at time of subscription
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("USD")

  // Auto-renewal
  autoRenew       Boolean @default(true)
  cancelAtPeriodEnd Boolean @default(false)

  // Cancellation tracking
  cancellationReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  payments           SubscriptionPayment[]
  invoices           Invoice[]
  pendingPlanChanges PendingPlanChange[]

  @@index([tenantId])
  @@index([planId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@map("subscriptions")
}

model SubscriptionPayment {
  id String @id @default(uuid())

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Payment details
  amount          Decimal @db.Decimal(10, 2)
  currency        String  @default("USD")
  status          String  @default("PENDING") // PENDING, SUCCEEDED, FAILED, REFUNDED
  paymentProvider String  // STRIPE, IYZICO

  // Provider-specific IDs
  stripePaymentIntentId String? @unique
  iyzicoPaymentId       String? @unique

  // Payment metadata
  paymentMethod String? // card, bank_transfer, etc.
  last4         String?
  cardBrand     String?

  // Error tracking
  failureCode    String?
  failureMessage String?
  retryCount     Int     @default(0)

  // Dates
  paidAt    DateTime?
  refundedAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  invoice Invoice?

  @@index([subscriptionId])
  @@index([status])
  @@index([createdAt])
  @@map("subscription_payments")
}

model Invoice {
  id String @id @default(uuid())

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  paymentId String? @unique
  payment   SubscriptionPayment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  // Invoice details
  invoiceNumber String  @unique
  status        String  @default("DRAFT") // DRAFT, OPEN, PAID, VOID, UNCOLLECTIBLE

  // Amounts
  subtotal Decimal @db.Decimal(10, 2)
  tax      Decimal @default(0) @db.Decimal(10, 2)
  total    Decimal @db.Decimal(10, 2)
  currency String  @default("USD")

  // Billing period
  periodStart DateTime
  periodEnd   DateTime

  // Dates
  dueDate   DateTime?
  paidAt    DateTime?
  voidedAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Metadata
  description String?
  notes       String?
  pdfUrl      String?

  @@index([subscriptionId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([dueDate])
  @@map("invoices")
}

model PendingPlanChange {
  id String @id @default(uuid())

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  currentPlanId String
  currentPlan   SubscriptionPlan @relation("PendingFromPlan", fields: [currentPlanId], references: [id], onDelete: Restrict)

  newPlanId String
  newPlan   SubscriptionPlan @relation("PendingToPlan", fields: [newPlanId], references: [id], onDelete: Restrict)

  // Change details
  newBillingCycle String // MONTHLY, YEARLY
  isUpgrade       Boolean

  // Financial details
  currentAmount   Decimal @db.Decimal(10, 2)
  newAmount       Decimal @db.Decimal(10, 2)
  prorationAmount Decimal @db.Decimal(10, 2)
  currency        String  @default("USD")

  // Payment tracking
  paymentRequired Boolean @default(true)
  paymentStatus   String  @default("PENDING") // PENDING, COMPLETED, FAILED
  paymentIntentId String? // Stripe or Iyzico payment intent ID
  paymentProvider String? // STRIPE, IYZICO

  // Scheduling
  scheduledFor DateTime? // For downgrades scheduled at period end
  appliedAt    DateTime?

  // Metadata
  reason          String? // User reason for change
  failureReason   String? // If payment fails

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([subscriptionId])
  @@index([paymentStatus])
  @@index([scheduledFor])
  @@map("pending_plan_changes")
}

// ========================================
// QR MENU CUSTOMIZATION
// ========================================

model QrMenuSettings {
  id        String   @id @default(uuid())
  tenantId  String   @unique
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Design customization
  primaryColor      String  @default("#3B82F6")  // Blue
  secondaryColor    String  @default("#1F2937")  // Gray
  backgroundColor   String  @default("#F9FAFB")  // Light gray
  fontFamily        String  @default("Inter")
  logoUrl           String?
  showRestaurantInfo Boolean @default(true)
  showPrices        Boolean @default(true)
  showDescription   Boolean @default(true)
  showImages        Boolean @default(true)

  // Layout options
  layoutStyle       String  @default("GRID") // GRID, LIST, COMPACT
  itemsPerRow       Int     @default(2)

  // Table-specific settings
  enableTableQR     Boolean @default(true)
  tableQRMessage    String  @default("Scan to view our menu")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("qr_menu_settings")
}

// ========================================
// POS SETTINGS
// ========================================

model PosSettings {
  id        String   @id @default(uuid())
  tenantId  String   @unique
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // POS operation modes
  enableTablelessMode    Boolean @default(false)  // Allow orders without table selection
  enableTwoStepCheckout  Boolean @default(false)  // Separate "Create Order" and "Payment" buttons
  showProductImages      Boolean @default(true)   // Show product images in POS menu
  enableCustomerOrdering Boolean @default(true)   // Allow customers to place orders from QR menu

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("pos_settings")
}

// ========================================
// INTEGRATION SETTINGS
// ========================================

model IntegrationSettings {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Integration type
  integrationType String   // PAYMENT_GATEWAY, POS_HARDWARE, THIRD_PARTY_API, DELIVERY_APP, ACCOUNTING, CRM, INVENTORY
  provider        String   // stripe, iyzico, pos_terminal, quickbooks, etc.
  name            String   // User-friendly name

  // Configuration (stored as JSON)
  config          Json     // Flexible config object based on integration type

  // Status
  isEnabled       Boolean  @default(false)
  isConfigured    Boolean  @default(false)

  // Metadata
  lastSyncedAt    DateTime?
  notes           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, integrationType, provider])
  @@index([tenantId])
  @@index([integrationType])
  @@map("integration_settings")
}

model ApiKey {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // API Key details
  name        String   // User-friendly name (e.g., "Production API", "Mobile App")
  key         String   @unique  // The actual API key (should be hashed in production)
  keyPrefix   String   // First few characters for identification (e.g., "pk_live_...")

  // Permissions & Scopes
  scopes      String[] // Array of permissions (e.g., ["orders:read", "orders:write", "menu:read"])

  // Webhook configuration
  webhookUrl  String?
  webhookEvents String[] @default([]) // Events to send to webhook (e.g., ["order.created", "order.updated"])

  // Status
  isActive    Boolean  @default(true)
  expiresAt   DateTime?

  // Usage tracking
  lastUsedAt  DateTime?
  usageCount  Int      @default(0)

  // Security
  ipWhitelist String[] @default([]) // Allowed IP addresses (empty = allow all)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([key])
  @@index([isActive])
  @@map("api_keys")
}

// ========================================
// CONTACT MESSAGES (Public)
// ========================================

model ContactMessage {
  id      String @id @default(uuid())
  name    String
  email   String
  phone   String?
  message String @db.Text

  // Status tracking
  status  String @default("NEW") // NEW, READ, REPLIED, ARCHIVED

  // Admin notes
  adminNotes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("contact_messages")
}

// ========================================
// CUSTOMER MANAGEMENT (CRM)
// ========================================

model Customer {
  id    String  @id @default(uuid())
  name  String
  email String?
  phone String?
  phoneVerified Boolean @default(false)

  // Loyalty & Engagement
  loyaltyPoints Int      @default(0)
  loyaltyTier   String   @default("BRONZE") // BRONZE, SILVER, GOLD, PLATINUM
  tags          String[] @default([]) // "VIP", "Regular", "New", etc.
  notes         String?  @db.Text

  // Referral System
  referralCode  String?   @unique // Unique code for this customer to share (optional)
  referredBy    String? // Referral code that was used to sign up

  // Statistics
  totalOrders  Int     @default(0)
  totalSpent   Decimal @default(0) @db.Decimal(10, 2)
  averageOrder Decimal @default(0) @db.Decimal(10, 2)

  // Birthday & Marketing
  birthday    DateTime?
  preferences Json?     // Dietary preferences, favorite items, etc.

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lastVisit DateTime?

  // Relations
  orders Order[] @relation("CustomerOrders")
  sessions CustomerSession[]
  loyaltyTransactions LoyaltyTransaction[]
  referralsMade CustomerReferral[] @relation("ReferralsMade")
  referralsReceived CustomerReferral? @relation("ReferralsReceived")

  @@unique([tenantId, email])
  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([email])
  @@index([phone])
  @@index([referralCode])
  @@index([loyaltyTier])
  @@map("customers")
}

// ========================================
// CUSTOMER SESSIONS & LOYALTY
// ========================================

model CustomerSession {
  id        String   @id @default(uuid())
  sessionId String   @unique // Public session identifier

  // Customer identification
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Session details
  tableId   String?
  phone     String? // Optional phone for identification
  isActive  Boolean  @default(true)

  // Session metadata
  userAgent String?
  ipAddress String?

  // Expiration
  expiresAt DateTime
  lastActivity DateTime @default(now())

  tenantId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sessionId])
  @@index([customerId])
  @@index([tenantId])
  @@index([expiresAt])
  @@map("customer_sessions")
}

model LoyaltyTransaction {
  id          String   @id @default(uuid())

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Transaction details
  type        String  // EARNED, REDEEMED, EXPIRED, ADJUSTMENT, BONUS, REFERRAL
  points      Int     // Positive for earned, negative for redeemed
  description String

  // Order reference (if applicable)
  orderId String?
  orderNumber String?
  orderAmount Decimal? @db.Decimal(10, 2)

  // Referral tracking
  referredCustomerId String? // Customer who was referred (for referral bonuses)

  // Balance tracking
  balanceBefore Int // Points balance before transaction
  balanceAfter  Int // Points balance after transaction

  // Metadata
  metadata Json? // Additional data like promotion ID, birthday bonus, etc.

  createdAt DateTime @default(now())

  @@index([customerId])
  @@index([createdAt])
  @@index([type])
  @@map("loyalty_transactions")
}

model PhoneVerification {
  id        String   @id @default(uuid())
  phone     String
  code      String   // 6-digit OTP code
  verified  Boolean  @default(false)
  expiresAt DateTime // OTP expires after 10 minutes

  // Session tracking
  sessionId String?
  tenantId  String

  // Rate limiting
  attempts  Int      @default(0)
  maxAttempts Int    @default(3)

  createdAt DateTime @default(now())
  verifiedAt DateTime?

  @@index([phone, tenantId])
  @@index([code])
  @@index([expiresAt])
  @@map("phone_verifications")
}

model CustomerReferral {
  id              String   @id @default(uuid())

  // Referrer (person who shared the referral code)
  referrerId      String
  referrer        Customer @relation("ReferralsMade", fields: [referrerId], references: [id], onDelete: Cascade)

  // Referred (person who used the referral code)
  referredId      String   @unique
  referred        Customer @relation("ReferralsReceived", fields: [referredId], references: [id], onDelete: Cascade)

  // Referral details
  referralCode    String   // Unique code used
  status          String   @default("PENDING") // PENDING, COMPLETED, EXPIRED

  // Rewards
  referrerReward  Int      @default(0) // Points given to referrer
  referredReward  Int      @default(0) // Points given to referred customer
  rewardedAt      DateTime?

  createdAt DateTime @default(now())
  completedAt DateTime? // When referred customer completed qualifying action

  @@index([referrerId])
  @@index([referredId])
  @@index([referralCode])
  @@index([status])
  @@map("customer_referrals")
}

// ========================================
// NOTIFICATION SYSTEM
// ========================================

model Notification {
  id    String @id @default(uuid())
  title String
  message String @db.Text
  type  String // INFO, WARNING, ERROR, SUCCESS, ORDER, STOCK, SYSTEM

  // Notification data (for deep links, actions, etc.)
  data Json?

  // Target
  userId   String?
  user     User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Delivery
  isGlobal Boolean @default(false) // If true, sent to all users in tenant
  priority String  @default("NORMAL") // LOW, NORMAL, HIGH, URGENT

  createdAt DateTime @default(now())
  expiresAt DateTime?

  // Relations
  readBy UserNotificationRead[]

  @@index([tenantId])
  @@index([userId])
  @@index([createdAt])
  @@map("notifications")
}

model UserNotificationRead {
  id String @id @default(uuid())

  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  readAt DateTime @default(now())

  @@unique([notificationId, userId])
  @@index([userId])
  @@index([notificationId])
  @@map("user_notification_reads")
}

// ========================================
// CUSTOMER REQUEST SYSTEM
// ========================================

model WaiterRequest {
  id      String @id @default(uuid())
  message String?
  status  String @default("PENDING") // PENDING, ACKNOWLEDGED, COMPLETED
  sessionId String

  tableId String
  table   Table @relation(fields: [tableId], references: [id], onDelete: Cascade)

  acknowledgedAt   DateTime?
  acknowledgedById String?
  acknowledgedBy   User? @relation("AcknowledgedWaiterRequests", fields: [acknowledgedById], references: [id], onDelete: SetNull)

  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tableId])
  @@index([status])
  @@index([sessionId])
  @@map("waiter_requests")
}

model BillRequest {
  id        String @id @default(uuid())
  status    String @default("PENDING") // PENDING, ACKNOWLEDGED, COMPLETED
  sessionId String

  tableId String
  table   Table @relation(fields: [tableId], references: [id], onDelete: Cascade)

  acknowledgedAt   DateTime?
  acknowledgedById String?
  acknowledgedBy   User? @relation("AcknowledgedBillRequests", fields: [acknowledgedById], references: [id], onDelete: SetNull)

  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tableId])
  @@index([status])
  @@index([sessionId])
  @@map("bill_requests")
}

// ========================================
// DESKTOP APPLICATION RELEASES
// ========================================

model DesktopRelease {
  id          String   @id @default(uuid())
  version     String   @unique  // e.g., "0.2.6" (synced with web app)
  releaseTag  String   @unique  // e.g., "v0.2.6"

  published   Boolean  @default(false)
  pubDate     DateTime @default(now())

  // GitHub Release URLs for each platform
  windowsUrl       String?
  windowsSignature String?
  macArmUrl        String?
  macArmSignature  String?
  macIntelUrl      String?
  macIntelSignature String?
  linuxUrl         String?
  linuxSignature   String?

  // Release metadata
  releaseNotes String  @db.Text // Markdown formatted release notes
  changelog    String? @db.Text // Detailed changelog
  downloadCount Int    @default(0) // Total downloads across all platforms

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([version])
  @@index([published, pubDate])
  @@map("desktop_releases")
}

// ========================================
// Z REPORT (END OF DAY) SYSTEM
// ========================================

model ZReport {
  id            String   @id @default(uuid())
  reportNumber  String   // Auto-generated report number (e.g., "Z-20250117-001")
  reportDate    DateTime // End of day date
  closingTime   DateTime @default(now())

  // Closing details
  closingType   String   @default("MANUAL") // MANUAL, AUTOMATIC

  // Staff who performed the closing
  closedById    String
  closedBy      User     @relation(fields: [closedById], references: [id], onDelete: Restrict)

  // Branch/Terminal information (optional for multi-location)
  branchName    String?
  terminalId    String?

  // Sales Summary
  totalSales              Decimal @db.Decimal(10, 2)
  totalOrders             Int
  totalDiscount           Decimal @default(0) @db.Decimal(10, 2)
  totalRefunds            Decimal @default(0) @db.Decimal(10, 2)
  netSales                Decimal @db.Decimal(10, 2) // totalSales - totalRefunds

  // Order Type Breakdown
  dineInSales             Decimal @default(0) @db.Decimal(10, 2)
  dineInOrders            Int     @default(0)
  takeawaySales           Decimal @default(0) @db.Decimal(10, 2)
  takeawayOrders          Int     @default(0)
  deliverySales           Decimal @default(0) @db.Decimal(10, 2)
  deliveryOrders          Int     @default(0)

  // Payment Method Summary
  cashPayments            Decimal @default(0) @db.Decimal(10, 2)
  cashPaymentCount        Int     @default(0)
  cardPayments            Decimal @default(0) @db.Decimal(10, 2)
  cardPaymentCount        Int     @default(0)
  digitalPayments         Decimal @default(0) @db.Decimal(10, 2)
  digitalPaymentCount     Int     @default(0)

  // Cash Drawer Summary
  openingCash             Decimal @db.Decimal(10, 2)
  expectedCash            Decimal @db.Decimal(10, 2)
  countedCash             Decimal @db.Decimal(10, 2)
  cashDifference          Decimal @db.Decimal(10, 2) // countedCash - expectedCash
  cashInOut               Decimal @default(0) @db.Decimal(10, 2) // Non-sales movements

  // Refunds & Cancellations
  cancelledOrders         Int     @default(0)
  cancelledOrdersAmount   Decimal @default(0) @db.Decimal(10, 2)
  refundedPayments        Int     @default(0)
  refundedAmount          Decimal @default(0) @db.Decimal(10, 2)

  // Staff Performance (stored as JSON for flexibility)
  staffPerformance        Json?   // Array of {staffId, staffName, sales, orders, refunds}

  // Product Group Sales (stored as JSON)
  categoryBreakdown       Json?   // Array of {categoryId, categoryName, sales, quantity}

  // Top Products (stored as JSON)
  topProducts             Json?   // Array of {productId, productName, quantity, revenue}

  // System Status
  openChecks              Int     @default(0) // Should be 0 for successful closing
  openChecksAmount        Decimal @default(0) @db.Decimal(10, 2)

  // Metadata
  notes                   String? @db.Text
  systemGenerated         Boolean @default(false)

  // Report export tracking
  pdfExported             Boolean  @default(false)
  pdfUrl                  String?
  excelExported           Boolean  @default(false)
  excelUrl                String?
  emailSent               Boolean  @default(false)
  emailSentAt             DateTime?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cashDrawerMovements CashDrawerMovement[]

  @@unique([tenantId, reportNumber])
  @@index([tenantId])
  @@index([reportDate])
  @@index([closedById])
  @@map("z_reports")
}

model CashDrawerMovement {
  id          String   @id @default(uuid())
  type        String   // OPENING, CLOSING, CASH_IN, CASH_OUT, ADJUSTMENT
  amount      Decimal  @db.Decimal(10, 2)
  reason      String?
  notes       String?  @db.Text

  // Cash counting details (for CLOSING type)
  denominationBreakdown Json? // {100: 5, 50: 10, 20: 15, etc.}

  // Z Report reference (optional, null for daily movements)
  zReportId String?
  zReport   ZReport? @relation(fields: [zReportId], references: [id], onDelete: Cascade)

  // Staff who performed the movement
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Restrict)

  tenantId String

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([zReportId])
  @@index([userId])
  @@index([createdAt])
  @@map("cash_drawer_movements")
}
